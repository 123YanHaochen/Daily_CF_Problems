**提示 1：** 首先，观察本题的数据范围是 $5000$ ，只要我们可以 $\mathcal{O}(1)$ 或比较小的时间内得到子字符串是否合法的判断，则总用时是 $\mathcal{O}(n^2)$ 的，可以完成本题。

**提示 2：** 对于一个字符串，怎么判断是否可以替换 `'?'` 使得整体成为一个合法的括号序列呢？

如果没有问号，一个括号字符串是否合法怎么判断呢？

我们发现，从头遍历到尾，每次遇到前括号就 $+1$ ，否则 $-1$ ，要求最后结果为 $0$ ，且中间不经过负数。我们称之为一个前缀和。

那如果有问号怎么办呢？

我们先分配问号为 `'('` 和 `')'` ，**使得 `'('` 的个数和 `')'` 的个数相等**。

再 **把前面位置的 `'?'` 替换为 `'('` ，后面位置的 `'?'` 替换为 `')'`**，再检查是否中间出现了负数。

为什么前面的问号用前括号替代，后面的括号用后括号替代呢？因为这样能使得中间的数值更大，更不容易出现负数，实际上是一种贪心。

但如果我们对于每个字符串都完整地进行一遍上述替代，每个字符串的判断时间是跟字符串长度成正比的，不满足本题的要求。

于是我们要用到子字符串之间的相关关系，即 **一个子字符串添加其右侧的字符会得到一个新的子字符串**。

我们在保证中间经历数值均非负的情况下，最小化我们最后的前缀和。如果该前缀和为 $0$ ，则该子字符串满足要求，则我们最终的计数结果 $+1$ .

我们一开始强行令所有的问号为 `')'` ，而在新增字符的过程中，如果前缀和是负的了，我们只需要调整一个问号从 `')'` 变为 `'('` ，则可以使得前缀和 $+2$ ，这样我们仍可保证当前字符串的前缀和是可达的最小值。

因此我们只需要维护 **当前能达到的最小值以及可以转化的右括号的数量** 。

如果某一刻出现不可避免的负数，即前缀和已经为负，但不存在可以变成左括号的右括号，则后面的字符串不可能满足要求，直接退出循环。

总时间复杂度为 $\mathcal{O}(n^2)$ .

#### 具体代码如下（只包含中间处理部分）——

```Python []
def main():
    s = I()
    n = len(s)

    ans = 0
    for i in range(n):
        cur = 0
        right = 0
        for j in range(i, n):
            if s[j] == '(':
                cur += 1
            elif s[j] == ')':
                cur -= 1
            else:
                cur -= 1
                right += 1
            if cur < 0:
                if right == 0: break
                right -= 1
                cur += 2
            if cur == 0:
                ans += 1

    print(ans)
```